<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V1 Dashcam Control</title>
    <!-- Link to the new external stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Link to Font Awesome for icons -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all.css') }}">
</head>
<body>
    <div class="container">
        <h1><i class="fa-solid fa-video"></i> V1 Dashcam Control Center</h1>
        <div id="message-box" class="message"></div>

        {% if is_full_mode %}
        <div class="dashboard-layout">
            <div class="left-column">
                <div class="section">
                    <h2><i class="fa-solid fa-sliders"></i> Controls</h2>
                    <div class="actions-grid">
                        <button onclick="postAction('/actions/start_recording')"><i class="fa-solid fa-play"></i> Start Recording</button>
                        <button onclick="postAction('/actions/stop_recording')" class="button-danger"><i class="fa-solid fa-stop"></i> Stop Recording</button>
                        <button onclick="postAction('/actions/reconnect_v1')"><i class="fa-solid fa-arrows-rotate"></i> Reconnect V1</button>
                    </div>
                </div>

                <div class="section">
                    <h2><i class="fa-solid fa-gear"></i> Settings</h2>
                    <div class="settings-grid">
                        <div>
                            <label for="gps-toggle">GPS Overlay</label>
                            <label class="switch">
                                <input type="checkbox" id="gps-toggle" onchange="updateOverlaySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div>
                            <label for="v1-toggle">V1 Overlay</label>
                            <label class="switch">
                                <input type="checkbox" id="v1-toggle" onchange="updateOverlaySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div>
                            <label for="preview-toggle">Live Preview</label>
                            <label class="switch">
                                <input type="checkbox" id="preview-toggle" onchange="togglePreview()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2><i class="fa-solid fa-power-off"></i> System</h2>
                    <button onclick="shutdownPi()" class="button-danger"><i class="fa-solid fa-power-off"></i> Shutdown Pi</button>
                </div>
            </div>

            <div class="right-column">
                <div class="section">
                    <h2><i class="fa-solid fa-display"></i> Live Preview</h2>
                    <!-- MODIFIED: Add ID to container and image, add placeholder -->
                    <div id="preview-wrapper">
                        <div class="preview-container" id="preview-container">
                            <img src="{{ url_for('video_feed') }}" alt="Live Video Feed" id="video-feed-img">
                            <div id="overlay-gps" class="preview-overlay-item"></div>
                            <div id="overlay-timestamp" class="preview-overlay-item"></div>
                            <div id="overlay-v1-alert" class="preview-overlay-item"></div>
                        </div>
                        <div class="preview-placeholder" id="preview-placeholder">
                            <p><i class="fa-solid fa-eye-slash"></i></p>
                            <p>Live preview is disabled to save bandwidth.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><i class="fa-solid fa-chart-simple"></i> Live Status</h2>
            <div id="status-container" class="status-grid">
                <div class="status-card"><h3>Loading...</h3></div>
            </div>
        </div>
        {% else %}
        <div class="section">
            <h2><i class="fa-solid fa-circle-info"></i> Web-Only Mode</h2>
            <p>Running in file management mode. Live preview and recording controls are disabled.</p>
        </div>
        {% endif %}

        <div class="section">
            <h2><i class="fa-solid fa-folder-open"></i> Recorded Clips</h2>
            <button onclick="refreshFiles()"><i class="fa-solid fa-arrows-rotate"></i> Refresh List</button>
            <ul id="file-list" class="file-list">
                <li>Loading file list...</li>
            </ul>
        </div>
    </div>

    <script>
        const messageBox = document.getElementById('message-box');
        const isFullMode = {{ is_full_mode|tojson }};
        // --- FIX: Conditionally define the video feed URL as a JavaScript variable ---
        // In full mode, this will be a URL string. In web-only mode, it will be 'null'.
        // The |tojson filter is crucial for correct syntax.
        const videoFeedUrl = {{ url_for('video_feed')|tojson if is_full_mode else 'null'|tojson }};
        
        function togglePreview() {
            const isChecked = document.getElementById('preview-toggle').checked;
            const videoImg = document.getElementById('video-feed-img');
            const previewContainer = document.getElementById('preview-container');
            const placeholder = document.getElementById('preview-placeholder');

            if (isChecked && videoFeedUrl) {
                // Show preview: set src, show container, hide placeholder
                videoImg.src = videoFeedUrl;
                previewContainer.style.display = 'block';
                placeholder.style.display = 'none';
                localStorage.setItem('showPreview', 'true');
            } else {
                // Hide preview: clear src, hide container, show placeholder
                videoImg.src = ""; // This is the key to stopping the stream
                previewContainer.style.display = 'none';
                placeholder.style.display = 'block';
                localStorage.setItem('showPreview', 'false');
            }
        }
        
        function initializePreviewState() {
            const previewToggle = document.getElementById('preview-toggle');
            // Default to 'true' if no setting is found
            const showPreview = localStorage.getItem('showPreview') !== 'false';
            
            previewToggle.checked = showPreview;
            togglePreview(); // Apply the state
        }

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? 'rgba(220, 53, 69, 0.1)' : 'rgba(13, 110, 253, 0.1)';
            messageBox.style.borderColor = isError ? 'var(--danger-color)' : 'var(--primary-color)';
            messageBox.style.color = isError ? '#f5c2c7' : '#b6d4fe';
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
        }

        async function postAction(url, body = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                showMessage(result.message, !response.ok);
                if (response.ok) {
                    updateStatus();
                }
            } catch (error) {
                showMessage('An error occurred: ' + error, true);
            }
        }

        function burnIn(filename) {
            if (confirm(`This will start a CPU-intensive burn-in process for ${filename}. The Pi will become slow. Are you sure?`)) {
                postAction('/actions/burn_in', { filename: filename });
            }
        }

        function updateOverlaySettings() {
            const showGps = document.getElementById('gps-toggle').checked;
            const showV1 = document.getElementById('v1-toggle').checked;
            postAction('/actions/set_overlays', { show_gps: showGps, show_v1: showV1 });
        }
        
        function shutdownPi() {
            if (confirm('Are you sure you want to completely shut down the Raspberry Pi? The device will power off.')) {
                showMessage('Shutdown command sent. The web interface will now become unresponsive.');
                fetch('/actions/shutdown_pi', { method: 'POST' }).catch(error => {
                    console.error('Shutdown request sent, but an error is expected as the server terminates:', error);
                });
            }
        }

        async function updateStatus() {
            if (!isFullMode) return;
            try {
                const response = await fetch('/status');
                const status = await response.json();
                const container = document.getElementById('status-container');
                
                const v1AlertClass = status.v1.in_alert ? 'alert' : '';
                const recStatusText = status.recorder.is_recording ? 'RECORDING' : 'Idle';
                const recStatusClass = status.recorder.is_recording ? 'recording' : '';
                
                // --- USE NEW DETAILED STATUSES ---
                const v1ConnectionText = status.v1.connection_status; 
                let gpsStatusText = status.gps.status;
                if (status.gps.has_fix) {
                    gpsStatusText = `${status.gps.status} (${status.gps.num_sats} sats)`;
                }
                
                const v1AlertText = status.v1.in_alert ? `${status.v1.priority_alert_band} / ${status.v1.priority_alert_freq.toFixed(3)}` : 'None';
                const v1DirText = status.v1.in_alert ? status.v1.priority_alert_direction : '–';
                const v1StrText = status.v1.in_alert ? status.v1.priority_alert_strength : '0';

                container.innerHTML = `
                    <div class="status-card"><h3>Recorder</h3><p class="${recStatusClass}">${recStatusText}</p></div>
                    <div class="status-card"><h3>V1 Status</h3><p class="${v1AlertClass}">${v1ConnectionText}</p></div>
                    <div class="status-card"><h3>GPS Status</h3><p>${gpsStatusText}</p></div>
                    <div class="status-card"><h3>V1 Alert</h3><p class="${v1AlertClass}">${v1AlertText}</p></div>
                    <div class="status-card"><h3>Direction</h3><p class="${v1AlertClass}">${v1DirText}</p></div>
                    <div class="status-card"><h3>Strength</h3><p class="${v1AlertClass}">${v1StrText}</p></div>
                `;

                const overlayGps = document.getElementById('overlay-gps');
                const overlayTimestamp = document.getElementById('overlay-timestamp');
                const overlayV1 = document.getElementById('overlay-v1-alert');

                const showGps = document.getElementById('gps-toggle').checked;
                const showV1 = document.getElementById('v1-toggle').checked;

                // 1. Update GPS Overlay (Top Left)
                if (showGps && status.gps.has_fix) {
                    const speedInt = Math.round(status.gps.speed_mph);
                    overlayGps.textContent = `GPS: ${status.gps.latitude.toFixed(5)}, ${status.gps.longitude.toFixed(5)} | ${speedInt} MPH`;
                    overlayGps.style.display = 'block';
                } else {
                    overlayGps.style.display = 'none';
                }

                // 2. Update Timestamp Overlay (Top Right)
                // 'sv-SE' locale gives a nice YYYY-MM-DD HH:MM:SS format
                overlayTimestamp.textContent = new Date().toLocaleString('sv-SE');
                overlayTimestamp.style.display = 'block';

                // 3. Update V1 Alert Overlay (Bottom Left)
                if (showV1 && status.v1.in_alert) {
                    overlayV1.textContent = `V1 ALERT: ${status.v1.priority_alert_band} / ${status.v1.priority_alert_freq.toFixed(3)}GHz | Dir: ${status.v1.priority_alert_direction} | Str: ${status.v1.priority_alert_strength}`;
                    overlayV1.style.display = 'block';
                } else {
                    overlayV1.style.display = 'none';
                }

                // Update the toggle switches to match the state from the server
                if (status.overlays) {
                    document.getElementById('gps-toggle').checked = status.overlays.show_gps;
                    document.getElementById('v1-toggle').checked = status.overlays.show_v1;
                }
                
                refreshFiles(status.processing_files);

            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('status-container').innerHTML = '<div class="status-card"><h3>Error loading status.</h3></div>';
            }
        }

        async function refreshFiles(processingFiles = []) {
            try {
                const response = await fetch('/files');
                const files = await response.json();
                const list = document.getElementById('file-list');
                list.innerHTML = '';
                if (files.length === 0) {
                    list.innerHTML = '<li>No recordings found.</li>';
                } else {
                    files.forEach(file => {
                        const li = document.createElement('li');
                        
                        const processingItem = processingFiles.find(p => 
                            p.filename === file.name || p.filename === file.name.replace('.mp4', '_processed.mp4')
                        );
                        const isProcessing = !!processingItem;
                        const processingText = isProcessing ? `<span class="processing-text">(${processingItem.type}...)</span>` : '';
                        const isDisabled = isProcessing;

                        let analysisText = '';
                        let encounterClass = '';
                        
                        // --- MODIFIED: Generate analysis text with band types ---
                        if (file.analysis && file.analysis.has_alerts) {
                            // Join the bands array into a comma-separated string
                            const bandsText = file.analysis.bands.join(', ');
                            
                            // Display the bands, and optionally the point count
                            analysisText = ` <span class="encounter-text">(Encounter: ${bandsText})</span>`;
                            encounterClass = 'encounter';
                        }
                        
                        li.className = encounterClass;

                        li.innerHTML = `
                            <div class="file-info">
                                <i class="fa-solid fa-film"></i>
                                <span>${file.name} (${file.size})${analysisText} ${processingText}</span>
                            </div>
                            <div class="file-actions">
                                <a href="/download/video/${file.name}" class="button" ${isDisabled ? 'disabled' : ''}><i class="fa-solid fa-download"></i> Video</a>
                                ${file.has_log ? `<a href="/download/log/${file.log_name}" class="button" ${isDisabled ? 'disabled' : ''}><i class="fa-solid fa-file-csv"></i> Log</a>` : ''}
                                ${file.has_log ? `<button onclick="burnIn('${file.name}')" class="button-danger" ${isDisabled ? 'disabled' : ''}><i class="fa-solid fa-fire-flame-curved"></i> Burn-in</button>` : ''}
                            </div>
                        `;
                        list.appendChild(li);
                    });
                }
            } catch (error)
                console.error('Error fetching file list:', error);
                document.getElementById('file-list').innerHTML = '<li>Error loading file list.</li>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (isFullMode) {
                initializePreviewState(); // Set the initial preview state
                updateStatus();
                setInterval(updateStatus, 2000);
            }
            refreshFiles();
        });
    </script>
</body>
</html>